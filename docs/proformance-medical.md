在[cMedQA2](https://github.com/zhangsheng93/cMedQA2)上使用我们的checkpoint-11600 continue finetune

目前从2个epoch的Vicuna开始continue finetune，效果比3个epoch的在医疗问答数据更具有专业性，同时由于数据集构建的问题，会更加规范，比如经常性的加上“到正规医院检查”等等
- 同时验证了指令微调的有效性

## 无指令微调

使用脚本为finetune_others_continue.sh
```bash
TOT_CUDA="1,2,3"
CUDAs=(${TOT_CUDA//,/ })
CUDA_NUM=${#CUDAs[@]}
PORT="12345"

DATA_PATH="../dataset/instruction/cMedQA2/cMedQA2.json" 
OUTPUT_PATH="lora-Vicuna-medical"
MODEL_PATH="decapoda-research/llama-7b-hf"
lora_checkpoint="./lora-Vicuna/checkpoint-11600"
from_data_beginning=True # False
TEST_SIZE=1000

CUDA_VISIBLE_DEVICES=${TOT_CUDA} torchrun --nproc_per_node=$CUDA_NUM --master_port=$PORT finetune.py \
--data_path $DATA_PATH \
--output_path $OUTPUT_PATH \
--model_path $MODEL_PATH \
--eval_steps 200 \
--save_steps 200 \
--test_size $TEST_SIZE \
--resume_from_checkpoint $lora_checkpoint \
--ignore_data_skip $from_data_beginning

```

数据输入直接作为instruction，无input的格式，如
```
{
    "instruction": "双胞胎差异大，33周B超检查，一个双顶径89mm，腹围281mm，股骨70mm。另一个双顶径75mm，腹围266mm，股骨66mm。这样正常吗
",
    "input": "",
    "output": "从报告来看。这两个孩子的数据都有点偏离正常孕周的发育数据，但是由于你是双保胎。所以又不能用单胎的标准来看待。所以，而且
般双胎的话都是剖腹产。所以。只要你这两个孩子发育都很健康，没有什么器官脏器发育障碍就可以。从数据来看。双顶径89mm，腹围281mm，股骨70mm
双顶径75mm，腹围266mm，股骨66mm，都超过怀孕33周的发育数据，但是只要你孩子没有发育异常就可以，不需要太过担心。"
  }
```
数据大小是20w左右，在我们之前70w的数据上训练第3个epoch，大概会训练3.5个epoch左右

### 效果
Repetition Penalty=2,beam number=2
|  |  |  | |
| --- | --- | --- | --- |
| input | Vicuna7B-3epoch | Vicuna-medical7B | |
|身体乏力出虚汗脸色暗黄口干尿检说是肾阴虚出来的血检请大夫帮忙看看 | 这种情况可能是由于肾阴虚出来的血检请大夫帮忙看看。|肾阴虚主要表现为腰膝酸软，四肢发冷，畏寒，头晕，失眠，面色苍白，食欲不振，男子性功能下降等。建议你可以服用六味地黄丸调理一段时间，平时注意保暖 | |
|扁桃体炎引起的发烧该怎么治疗 | 扁桃体炎引起的发烧可以通过多种方式治疗，包括使用药物治疗、预防措施和手术治疗等。药物治疗可以通过使用各种药物来治疗扁桃体炎，例如乙酰氨基酸、抗炎药、抗氧化剂等。预防措施可以通过改善睡眠质量、减少咳嗽、避免食用咖啡因等来预防扁桃体炎发烧。手术治疗可以通过切除扁桃体炎发烧的部位进行手术治疗。| 扁桃体炎是一种常见的呼吸道感染性疾病，主要表现为咳嗽、咳痰、咽痛等。建议你到医院进行相关检查，明确病因后对症治疗。平时注意饮食清淡，不要吃辛辣刺激性食物，多喝水，保持心情舒畅，避免劳累和精神紧张，加强身体锻炼，增强体质，提高免疫力。| Min New Tokens=200|
|怀孕8个多月胎位：右枕前位，双项径：93MM心率：136，股骨长67MM，羊水65MM，发育正常么 | 是的，怀孕8个多月胎位右枕前位，双项径93MM，心率136，股骨长67MM，羊水65MM，发育正常。| 根据你的检查结果看，胎儿是正常的。建议你注意休息，保持心情舒畅，加强营养，定期孕检。希望对你有所帮助。平时要注意休息，不要过度劳累，合理膳食，多吃高蛋白优质蛋白食物多吃蔬菜水果，少吃生冷刺激性食物，多喝开水，保持心情舒畅，定期孕检，这样可以明确胎儿的发育情况。| |
| 晚上睡觉老做梦，一开始入睡困难到天亮起床时全身乏力没劲，请问有什么药吃了后能够睡的好| 建议您可以喝一杯咖啡或茶，这可以帮助您放松身心，并使您更容易入睡。此外，您还可以喝一杯牛奶或其他甜点，这也可以帮助您放松身心，并提高睡眠质量。| 你这种情况可能是神经衰弱导致的。建议你去医院查明原因再治疗。平时注意保暖，多喝水，不要吃辛辣刺激性食物，少吃生冷食物，多吃新鲜蔬菜和水果，以及富含维生素B族的食物，如红薯、香蕉、苹果等，还可以服用谷维素片或阿莫西林胶囊进行治疗。希望我的回答对你有所帮助。| |
| 请问脾肿瘤恶性和胰尾切除后左上腹到肩一直阵阵刺痛用什么药治| 脾肿瘤恶性和胰尾切除后左上腹到肩一直阵阵刺痛可以使用药物治疗，例如抗癌药、抗糖尿病药等。| 脾肿瘤恶性的情况是需要手术治疗的，建议你最好去正规医院进行手术治疗，以免影响身体健康。| |
| 1岁小孩拉肚子腹泻呕吐不知怎么办？| 1岁小孩可能因为过度饮食、缺乏运动或者其他原因，而导致肚子腹泻呕吐不知怎么办。建议给孩子提供更多的营养，增加活动量，以及定期进行身体检查。|你的情况可能是消化不良引起的，建议口服妈咪爱和颠茄片治疗。 | 1岁小孩可能因为过度饮食、缺乏运动或者其他原因，而导致肚子腹泻呕吐不知怎么办。建议给孩子提供更多的营养，增加活动量，以及定期进行身体检查。|
|男下女上精液会倒流吗| 是的，男下女上精液会倒流。|一般情况下是不会的，建议注意阴茎勃起时间长达3-5分钟以上。 | Repetition Penalty=3.0|
| 感冒之后脸和脖子有点水肿是什么原因| 感冒之后脸和脖子有点水肿的原因可能是因为病毒在血液中流动，导致血液循环不平衡。此外，也可能是由于病毒对血管系统造成的损害，导致血液循环不平衡。| 感冒后脸和脖子有点水肿，可能是感冒引起的皮肤炎症，建议去医院检查一下，确诊后对症治疗。| |
| 胃里往上返酸水，有时打咯怎么办|可以尝试吃更多的维生素C、B6和B12，这些维生素会帮助改善消化系统的功能，并且有助于减少咳嗽。此外，可以尝试吃更多的蔬菜和水果，因为它们富含维生素和矿物质，有助于改善消化系统的功能。 | 你这种情况可能是胃炎引起的，建议你去医院做个胃镜检查确诊，如果是胃炎需要服用消炎药治疗。| |
| 为什么长冻疮的脚趾头会痒呢？| 长冻疮的脚趾头会痒呢，是因为它们被压在冰块上，导致脚趾头的肌肉损伤。此外，长冻疮也会导致脚趾头的肌肉变形，从而使脚趾头更容易痒。| 这种情况一般是由于毛囊炎引起的，建议你可以使用氧氟沙星软膏外涂治疗。| |
| 轻度脂肪肝，肝损伤转氨酶超高，口干口苦厉害吃什么药好？| 建议您可以尝试一些辅助药物，如甘草药、葡萄糖等，以帮助改善肝脏功能。此外，您还可以尝试多种食物来改善肝脏功能，例如豆类、水果、蔬菜、蛋白质等。|脂肪肝是一种常见的肝病，主要表现为脂肪性肝炎，其发病原因有很多，如肝炎、肝纤维疾病、肝结核病、肝硬化等。建议你到医院做个肝功能检查，明确诊断后在医生指导下进行治疗。 | |

- 由于这份数据集也不是很干净，很多病人回答的语言是非常口语的，效果一般。同时回复基本是“你这种情况一般是xxxxx，xxxxx建议到正规医院检查”这种形式
- 同时由于回复中缺乏一定的逻辑相关性，医生一般会直接给出结果，模型缺乏类似chain of thought式的推理以及专业性的知识前提


不过他将丧失原本有的能力，会将所有的问题导向医疗意图。不过目前缺乏一定的导向性回复会随机回答，如
```
>写一份排序的python代码
你说的这种情况应该是需要到医院进行检查，确诊后再对症治疗。
```

## 带指令微调

手动写了几个相关问题的prompt
```
prompt_list = ["请为下面病例诊断并给出解决方案", "扮演一位专业的医生，为下面病人的问题提供解答",
               "请解答下面病人的疑惑", "根据这个医学问题，做出回答", "下面是一个病患和医生问答的场景"]
```

相关处理脚本代码如下
```python
import json
import random

question_path = "./cMedQA2/question.csv"
answer_path = "./cMedQA2/answer.csv"

question_dict = {}
with open(question_path, 'r') as f:
    for i in f:
        q, text = i.split(",")[0], "".join(i.split(",")[1:])
        question_dict[q] = text.strip('\n').strip().strip(":")

instruction_list = []
prompt_list = ["请为下面病例诊断并给出解决方案", "扮演一位专业的医生，为下面病人的问题提供解答",
               "请解答下面病人的疑惑", "根据这个医学问题，做出回答", "下面是一个病患和医生问答的场景"]
id = [0, 1, 2, 3, 4]
prefix_input = ["", "", "", "", "病人:"]
suffix_input = ["", "", "", "", "\n医生:"]
num = 0
output_dict = {}
with open(answer_path, 'r') as f:
    for i in f:
        ans, q, text = i.split(",")[0], i.split(",")[1], "".join(i.split(",")[2:])
        text = text.strip('\n').strip().strip(":")
        if text == "content": continue
        question = question_dict[q]
        prompt_id = random.choice(id)
        output_item = {
            "instruction": prompt_list[prompt_id],
            "input": prefix_input[prompt_id]+question+suffix_input[prompt_id],
            "output": text,
        }
        num += 1
        instruction_list.append(output_item)

print(num)
json.dump(instruction_list, open("./cMedQA2_v2.json", 'w'), ensure_ascii=False, indent=2)
```
处理完的数据样例如下：
```
{
    "instruction": "扮演一为专业的医生，为下面病人的问题提供解答",
    "input": "停经十四天，会怀孕吗停经十四天，特别恶心已经停经十四天了，性生活频繁，出现恶心的症状，而
且特别频繁严重，头疼，易疲惫，以前来月经都特别准，推迟不会超过三天，请问这怀孕概率大吗",
    "output": "月经延迟十四天而且伴随恶心，头痛，乏力的现象，那么考虑怀孕的概率是非常大的，建议你去医
检查血HCG或者B超确诊是否怀孕，如果怀孕了，那么怀孕的天数大概是44天如果打算保留这个孩子，从现在开始要戒
烟酒，不要同房，注意休息，饮食方面要少吃辛辣刺激的，腌制，油炸，烧烤的食物，不要吃凉性的食物，不要吃螃
蟹甲鱼等寒性食品，容易流产，定期孕检"
  }
```
使用脚本为finetune_others_continue.sh
```bash
TOT_CUDA="1,2,3"
CUDAs=(${TOT_CUDA//,/ })
CUDA_NUM=${#CUDAs[@]}
PORT="12345"

DATA_PATH="../dataset/instruction/cMedQA2/cMedQA2_v2.json" 
OUTPUT_PATH="lora-Vicuna-medical2"
MODEL_PATH="decapoda-research/llama-7b-hf"
lora_checkpoint="./lora-Vicuna/checkpoint-11600"
from_data_beginning=True # False
TEST_SIZE=1000

CUDA_VISIBLE_DEVICES=${TOT_CUDA} torchrun --nproc_per_node=$CUDA_NUM --master_port=$PORT finetune.py \
--data_path $DATA_PATH \
--output_path $OUTPUT_PATH \
--model_path $MODEL_PATH \
--eval_steps 200 \
--save_steps 200 \
--test_size $TEST_SIZE \
--resume_from_checkpoint $lora_checkpoint \
--ignore_data_skip $from_data_beginning

```

### 效果
Repetition Penalty=2,beam number=2
|  |  |  | |
| --- | --- | --- | --- |
| input | Vicuna7B-3epoch | Vicuna-medical7B | |
|根据这个医学问题，做出回答。身体乏力出虚汗脸色暗黄口干尿检说是肾阴虚出来的血检请大夫帮忙看看 | 身体乏力出虚汗脸色暗黄口干尿检说可能是因为肾阴虚出来的血检请大夫帮忙看看。此外，也可能是由于肾血管疼痛、肾血管疼痛等原因引起的。建议您尽快就大夫帮忙进行诊断和治疗，以确定正确的诊断和治疗方案。如果您有任何疼痛或其他症状，请立即咨询医生。|肾阴虚主要表现为腰膝酸软，四肢发冷，头晕，眼花，面色苍白，失眠多梦，食欲不振等。建议服用六味地黄丸，金匮肾气丸，双枇材丸治疗。 | |
|根据这个医学问题，做出回答。扁桃体炎引起的发烧该怎么治疗 | 扁桃体炎引起的发烧可以通过使用药物治疗，例如乙酰氨基酸、抗炎药和抗氧化剂等。此外，也可以通过改善生活方式，如减少咖啡因和糖分的摄入，加强锻炼，保持良好的睡眠习惯等。| 扁桃体炎是一种常见的传染性疾病，主要表现为发热，严重者还会出现头痛、鼻塞、咳嗽等症状。建议你到医院进行详细检查，确诊后对症治疗，以免影响身体健康。平时注意多喝水，多吃水果和蔬菜，不要吃辛辣刺激性食物，保持心情舒畅，尽量避免受凉，避免感冒。| Min New Tokens=200|
|根据这个医学问题，做出回答。怀孕8个多月胎位：右枕前位，双项径：93MM心率：136，股骨长67MM，羊水65MM，发育正常么 |怀孕8个多月胎位的右枕前位，双项径为93MM，心率为136，股骨长为67MM，羊水为65MM，发育正常。 | 你的情况考虑是胎位不正，建议你到医院做B超检查，明确胎儿的情况后再对症治疗。| |
| 根据这个医学问题，做出回答。晚上睡觉老做梦，一开始入睡困难到天亮起床时全身乏力没劲，请问有什么药吃了后能够睡的好| 这种睡眠问题可能是因为缺乏睡眠药物或者其他药物。建议您咨询医生以获得更多信息和建议。| 你的情况可能是脑供血不足导致的，建议你去医院做个脑电图检查，确诊后对症治疗。| |
| 根据这个医学问题，做出回答。请问脾肿瘤恶性和胰尾切除后左上腹到肩一直阵阵刺痛用什么药治| 脾肿瘤恶性和胰尾切除后左上腹到肩一直阵阵刺痛可以通过使用药物治疗，例如抗癌药、抗糖尿病药等。| 脾肿瘤恶性和胰尾切除后左上腹到肩一直阵阵刺痛用什么药治？建议你去医院检查一下，如果是脾肿瘤恶性的话，需要手术治疗，可以选择中西医结合治疗，平时注意保暖，多喝水，不要吃辛辣刺激的食物，多吃些清淡的食物，希望我的回答对你有所帮助。| Min New Tokens=200|
| 根据这个医学问题，做出回答。1岁小孩拉肚子腹泻呕吐不知怎么办？| 这种情况可能是因为孩子的肠道没有完全形成，或者他们正在饮食中吃到了过多的糖分，导致肠道内部生理变化。建议家长给孩子提供更多的水果和蔬菜，以及少量的高糖食品，以改善肠道的健康状况。|小儿腹泻的原因有很多，如食物过敏、消化不良、胃肠道疾病等，建议你到医院做一下腹镜检查，明确诊断后对症治疗。 | |
|根据这个医学问题，做出回答。男下女上精液会倒流吗| 是的，男下女上精液会倒流。|一般情况下是不会倒流的，但是有时候因为阴茎比较大，或者由于性交过程中经常使用手法导致，可能会造成射精后进入阴道，引起射精后射精之前的精液倒流。 | Repetition Penalty=3.0|
| 根据这个医学问题，做出回答。感冒之后脸和脖子有点水肿是什么原因| 感冒之后脸和脖子有点水肿的原因可能是因为感冒会导致肌肉酸化，从而使肌肉变得更容易损伤，也可能是因为感冒会导致肌肉失去力量，导致脸和脖子变得更容易发生水肿。| 你的情况考虑是感冒引起的，建议你可以口服抗病毒药物治疗。| |
| 根据这个医学问题，做出回答。胃里往上返酸水，有时打咯怎么办| 胃里往上返酸水是一种常见的胃病，可以通过多种方法来治疗。首先，需要控制食物中的糖分和脂肪分量，以降低胃部内热量；其次，需要改善饮食习惯，减少高热量、高脂肪、高糖分的食物；最后，可以使用消化药等药物进行治疗。| 你的情况可能是胃炎引起的，建议你去医院做个胃镜检查，确诊后对症治疗。| |
| 根据这个医学问题，做出回答。为什么长冻疮的脚趾头会痒呢？| 长冻疮的脚趾头会痒呢，是因为它们被压在冰块上，导致脚趾头的肌肉损伤，并且可能会引起脚趾头的疼痛。| 可能是由于局部湿热引起的，建议你可以用点酒糖洗液或者消炎止痒溶液来治疗一下，平时注意保暖| Repetition Penalty=3.0|
| 根据这个医学问题，做出回答。轻度脂肪肝，肝损伤转氨酶超高，口干口苦厉害吃什么药好？| 轻度脂肪肝的治疗方法包括改善饮食和锻炼，以减少脂肪量，同时提高肝脏功能。此外，还可以使用辅助药物，例如抗肝炎药、抗肝癌药等，以改善肝脏功能。|脂肪肝是一种常见的肝病，主要表现为脂肪性肝炎，其发病原因有很多，如肝炎、肝结核、肝硬化、肝癌等。建议你去医院做个肝功能检查，明确诊断后再对症治疗。 | |

因为是根据相关的指令来对特定任务进行生成，带指令的微调还保存着原来一定的能力,但不多
```
>写一份排序的python代码
可以使用sorted()方法对列表进行排序，具体参考答案需要根据自己的情况选择最合适的方法
>自然语言处理是什么
孕妇感冒可以服用阿莫西林颗粒和小儿感冒颗粒治疗。
```

## 目前存在的问题
- 1、对训练数据的拟合还不够，这种类型的数据可能训练轮数得增多，或者将模型训练参数调大
- 2、目前这个数据集有很多相同的问题不同的回答，可以把他融合在一起训练
- 3、里面有一些问题是多轮对话拆开的，这个由于没有标记所以难以判断
- 4、可以和英文的语料一起训练

## todo

- [x] 完成在2个epoch的Vicuna开始的continue_finetune的无指令微调
- [x]   完成在2个epoch的Vicuna开始的continue_finetune的带指令微调
- [ ]   将相同的医疗数据融合
- [ ]   从1个epoch开始微调
- [ ]   从头开始微调
- [ ]   融合英文的医疗问答数据